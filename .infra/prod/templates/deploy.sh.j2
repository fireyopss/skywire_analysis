#!/bin/bash
set -e

# Deployment script for {{ app_name }}
# Usage: ./deploy.sh [branch]

BRANCH=${1:-main}
APP_DIR="{{ app_directory }}/app"
BACKUP_DIR="{{ app_directory }}/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "ğŸš€ Starting deployment of {{ app_name }} (branch: $BRANCH)"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup current version
if [ -d "$APP_DIR" ]; then
    echo "ğŸ“¦ Creating backup of current version..."
    tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$APP_DIR" .
    echo "âœ… Backup created: $BACKUP_DIR/backup_$TIMESTAMP.tar.gz"
fi

# Update code
echo "ğŸ”„ Updating code from repository..."
cd "$APP_DIR"
git fetch origin
git checkout "$BRANCH"
git pull origin "$BRANCH"

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
npm ci

# Build application
echo "ğŸ”¨ Building application..."
npm run build

# Restart application
echo "ğŸ”„ Restarting application..."
pm2 restart {{ app_name }} || pm2 start ecosystem.config.js

# Wait for application to start
echo "â³ Waiting for application to start..."
sleep 5

# Health check
echo "ğŸ” Performing health check..."
if curl -f http://localhost:{{ app_port }}/health >/dev/null 2>&1; then
    echo "âœ… Health check passed!"
else
    echo "âŒ Health check failed!"
    echo "ğŸ”„ Rolling back to previous version..."
    
    # Restore from backup
    if [ -f "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" ]; then
        cd "$APP_DIR"
        tar -xzf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz"
        pm2 restart {{ app_name }}
        echo "âœ… Rollback completed"
    fi
    exit 1
fi

# Cleanup old backups (keep last 5)
echo "ğŸ§¹ Cleaning up old backups..."
cd "$BACKUP_DIR"
ls -t backup_*.tar.gz | tail -n +6 | xargs -r rm

# Reload Nginx (in case of configuration changes)
echo "ğŸ”„ Reloading Nginx..."
sudo nginx -t && sudo systemctl reload nginx

echo "ğŸ‰ Deployment completed successfully!"
echo "ğŸŒ Application is available at: http://{{ app_domain }}"

# Show PM2 status
echo "ğŸ“Š PM2 Status:"
pm2 status {{ app_name }}